---
- name: Update packages list
  become: yes
  apt:
    update_cache: yes
  tags:
    - apt

- name: Install updates
  become: yes
  apt:
    upgrade: yes
  tags:
    - apt

- name: Check if wsl.conf is installed
  stat:
    path: "/etc/wsl.conf"
  register: wsl_conf_is_installed
  tags:
    - wsl

- name: Enable Systemd
  become: yes
  when: "not wsl_conf_is_installed.stat.exists"
  copy:
    dest: "/etc/wsl.conf"
    content: |
      [boot]
      systemd=true
  tags:
    - system

- name: Installing Common Apt packages
  become: yes
  become_method: sudo
  apt:
    pkg:
      - software-properties-common
      # - vim
      - tmux
      - htop
      - jq
      - unzip
      - git
      - gh
      - libgtk-3-dev
      - libnotify-dev
      - libgconf-2-4
      - libnss3
      - libxss1
      - libasound2
    state: present
  tags:
    - apt



- name: Setup Git user name
  git_config:
    name: user.name
    scope: global
    value: "{{ git_user_name }}"
  tags:
    - git

- name: Setup Git user email
  git_config:
    name: user.email
    scope: global
    value: "{{ git_user_email }}"
  tags:
    - git

- name: Setup Git Pull Rebase
  git_config:
    name: pull.rebase
    scope: global
    value: true
  tags:
    - git

- name: Setup Git Prune on Fetch
  git_config:
    name: pull.rebase
    scope: global
    value: true
  tags:
    - git

- name: Setup Git Differentiate Moved Lines
  git_config:
    name:  diff.colorMoved
    scope: global
    value: zebra
  tags:
    - git

- name: Setup Git Default branch to Main
  git_config:
    name:  init.defaultBranch
    scope: global
    value: main
  tags:
    - git

- name:  Create '.gitignore_global' file if not exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.gitignore_global"
  register: gitignore_stat
  tags:
    - git

- name:  Create '.gitignore_global' file
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.gitignore_global"
    state: touch
  when: not gitignore_stat.stat.exists
  tags:
    - git

- name:  Add gitignores to '.gitignore_global'
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.gitignore_global"
    line: "{{ item }}"
    state: present
  loop: "{{ git_ignore_patterns }}"
  tags:
    - git

- name:  Set excludes
  ansible.builtin.git_config:
    scope: global
    name: core.excludesfile
    value: "{{ ansible_user_dir }}/.gitignore_global"
  tags:
    - git

- name: Configure private aliases
  become: yes
  blockinfile:
    state: present
    insertafter: EOF
    dest: /etc/sysctl.conf
    marker_begin: "begin CUSTOM ansible marker"
    marker_end: "end CUSTOM ansible marker"
    content: |
      vm.overcommit_memory = 1

- name: Enable thp globally
  become: yes
  command: echo never > /sys/kernel/mm/transparent_hugepage/enabled


- name: Configure private aliases
  blockinfile:
    state: present
    insertafter: EOF
    dest: ~/.bashrc
    marker_begin: "begin CUSTOM BASHRC ansible marker"
    marker_end: "end CUSTOM BASHRC ansible marker"
    content: |
      alias ..="cd .."

- name: Shutdown WSL (to restart WSL)
  when: "not wsl_conf_is_installed.stat.exists"
  command: wsl.exe --shutdown
  tags:
    - wsl